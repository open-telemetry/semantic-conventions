name: Checks

on:
  push:
    branches:
      - main
  pull_request:
  merge_group:

permissions:
  contents: read
  pull-requests: write

jobs:
  markdownlint:
    runs-on: ubuntu-latest
    steps:
    - name: check out code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: install dependencies
      run: npm install

    - name: Check file and folder names
      run: make check-file-and-folder-names-in-docs

    - name: run markdownlint
      run: make markdownlint

  yamllint:
    runs-on: ubuntu-latest
    steps:
    - name: check out code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - uses: actions/setup-python@e797f83bcb11b83ae66e0230d6156d7c80228e7c # v6.0.0

    - name: install yamllint
      run: make install-yamllint

    - name: run yamllint
      run: yamllint . -f github

  link-check:
    uses: ./.github/workflows/reusable-link-check.yml

  markdown-toc-check:
    runs-on: ubuntu-latest
    steps:
    - name: check out code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: install dependencies
      run: npm install

    - name: run markdown-toc
      run: make markdown-toc

    - name: validate markdown-toc
      run: git diff --exit-code ':*.md' || (echo 'Generated markdown Table of Contents is out of date, please run "make markdown-toc" and commit the changes in this PR.' && exit 1)

  misspell:
    runs-on: ubuntu-latest
    steps:
    - name: check out code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

    - name: run misspell
      run: make misspell

  semantic-conventions:
    runs-on: ubuntu-latest
    steps:
    - name: check out code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
    - name: verify semantic convention tables
      run: make table-check

  semantic-conventions-registry:
    runs-on: ubuntu-latest
    steps:
    - name: check out code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
    - name: verify registry tables
      run: |
        make registry-generation
        git diff --exit-code './docs/registry/*.md' || (echo 'Attribute registry markdown is out of date, please run "make registry-generation" and commit the changes in this PR.' && exit 1)

  schemas-check:
    runs-on: ubuntu-latest
    steps:
    - name: check out code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
    - name: verify schemas
      run: make schema-check

  areas-dropdown-check:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
    - name: Components dropdown in issue templates
      run: |
        make generate-gh-issue-templates
        git diff --exit-code '.github/ISSUE_TEMPLATE' || (echo 'Dropdowns in issue templates is out of date, please run "make generate-gh-issue-templates" and commit the changes in this PR. Please note, if you are running it on Mac OS X, please make sure to use GNU version of sed instead of default "sed".' && exit 1)

  policies-check:
    runs-on: ubuntu-latest
    steps:
    - name: check out code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
    - name: verify semantic conventions yaml definitions
      run: make check-policies

  polices-test:
    runs-on: ubuntu-latest
    steps:
    - name: check out code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
    - name: verify semantic conventions yaml definitions
      run: make test-policies

  dead-yaml-check:
    runs-on: ubuntu-latest
    steps:
    - name: check out code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
    - name: find signals defined in yaml files that are not used in the markdown files
      run: make check-dead-yaml

  areas-table-check:
    runs-on: ubuntu-latest
    steps:
    - name: check out code
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
    - name: check if the areas table is out-of-date
      run: make areas-table-check

  validate-area-ownership:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Get changed files
        id: diff
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47
        with:
          dir_names: "true"
          files: model/**
          json: "true"

      - run: npm install yaml@2.8.1

      - name: Validate if PR has active owners
        if: steps.diff.outputs.any_changed == 'true'
        uses: actions/github-script@v8
        id: changes-active-codeowners
        with:
          script: |
            const fs = require('fs');
            const YAML = require('yaml')
            const fileContent = fs.readFileSync('./areas.yaml', 'utf8')
            const data = YAML.parse(fileContent)
            const script = require('.github/scripts/triage/check-changes-ownership.js')
            await script(core, context, github, data.areas, '${{ steps.diff.outputs.all_changed_files }}')
